---
import BaseLayout from '../layouts/BaseLayout.astro'
import ProductCard from '../components/ProductCard.astro'
import { supabase } from '../lib/supabase'

// Obtener productos con su categor√≠a
const { data: products, error } = await supabase
  .from('products')
  .select('*, categories(name)')
  .order('category_id', { ascending: true })
  .order('title', { ascending: true })

if (error) console.error('Error cargando productos:', error)

// Lista de categor√≠as prioritarias
const priorityOrder = [
  'Barricas acu√°ticas con plantas',
  'Barricas acu√°ticas con peces Koi y plantas',
  'Barricas Maceteros',
  'Proyectos Personalizados'
]

// Organizar cat√°logo por categor√≠as
const catalog: Record<string, any[]> = {}

for (const p of products ?? []) {
  const catName = p.categories?.name ?? 'Sin categor√≠a'
  if (!catalog[catName]) catalog[catName] = []
  catalog[catName].push(p)
}

// Ordenar categor√≠as con prioridad primero
const orderedCategories = Object.keys(catalog).sort((a, b) => {
  const idxA = priorityOrder.indexOf(a)
  const idxB = priorityOrder.indexOf(b)

  if (idxA !== -1 && idxB !== -1) return idxA - idxB
  if (idxA !== -1) return -1
  if (idxB !== -1) return 1

  return a.localeCompare(b)
})
---

<BaseLayout title="Cat√°logo Completo">
  <section class="py-32">
    <div class="max-w-6xl mx-auto px-6">
      <h1 class="section-title mb-4">Cat√°logo Completo</h1>
      <p class="text-gray-600 mb-12">
        Estanques, plantas, barricas y m√°s. Productos seleccionados y categorizados para ayudarte a
        encontrar lo que buscas.
      </p>

      {
        orderedCategories.map((cat) => {
          const items = catalog[cat]
          const isPriority = priorityOrder.includes(cat)

          return (
            <div class="mb-20">
              {isPriority && (
                <div class="inline-block bg-green-100 text-green-700 text-xs font-semibold px-3 py-1 rounded-full mb-3">
                  Categor√≠a destacada
                </div>
              )}

              <h2 class="text-3xl font-bold text-[var(--color-primary)] mb-8">{cat}</h2>

              {/* üî• MOBILE ‚Äî CARRUSEL HORIZONTAL */}
              <div class="md:hidden flex gap-6 overflow-x-auto whitespace-nowrap pb-4 snap-x snap-mandatory">
                {items.map((item) => (
                  <div class="min-w-[260px] snap-start">
                    <ProductCard
                      title={item.title}
                      description={item.description}
                      price={item.price}
                      image_url={item.image_url}
                      category_name={cat}
                    />
                  </div>
                ))}
              </div>

              {/* üñ•Ô∏è DESKTOP ‚Äî GRID NORMAL */}
              <div class="hidden md:grid grid-cols-2 lg:grid-cols-3 gap-10">
                {items.map((item) => (
                  <ProductCard
                    title={item.title}
                    description={item.description}
                    price={item.price}
                    image_url={item.image_url}
                    category_name={cat}
                  />
                ))}
              </div>
            </div>
          )
        })
      }
    </div>
  </section>
</BaseLayout>
