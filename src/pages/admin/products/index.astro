---
export const prerender = false

import AdminLayout from '../../../layouts/AdminLayout.astro'
import { supabase } from '../../../lib/supabase'
import type { Product } from '../../../types/database'

// Proteger ruta
const { data: sessionData } = await supabase.auth.getSession()
if (!sessionData.session) {
  return Astro.redirect('/admin/login')
}

// Obtener productos con categor√≠a incluida
const { data: products, error } = await supabase
  .from('products')
  .select('*, categories(name)')
  .order('created_at', { ascending: false })

if (error) {
  console.error('Error cargando productos:', error)
}

// Obtener categor√≠as
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name', { ascending: true })
---
<AdminLayout>
  <section class="min-h-screen px-6 py-10 bg-gray-100">
    <h1 class="text-3xl font-bold text-[var(--color-primary)] mb-8 text-center">üì¶ Productos</h1>

    <!-- BOT√ìN CREAR -->
    <div class="flex justify-center mb-10">
      <a href="/admin/products/new" class="btn-primary">‚ûï Crear Producto</a>
    </div>

    <!-- üîé FILTROS -->
    <div class="bg-white shadow-xl rounded-xl p-6 max-w-5xl mx-auto mb-6 flex flex-col sm:flex-row gap-4">

      <!-- SELECT CATEGOR√çA -->
      <select id="filterCategory" class="border rounded-lg px-4 py-2 w-full sm:w-60">
        <option value="all">Todas las categor√≠as</option>
        {
          categories?.map((cat) => (
            <option value={cat.name}>{cat.name}</option>
          ))
        }
      </select>

      <!-- BUSCADOR -->
      <input
        id="searchInput"
        type="text"
        placeholder="Buscar producto..."
        class="border rounded-lg px-4 py-2 w-full sm:flex-1"
      />
    </div>

    <!-- TABLA / CARDS -->
    <div class="bg-white shadow-xl rounded-xl p-6 max-w-5xl mx-auto" id="productsContainer">
      
      <!-- MENSAJE SI NO HAY -->
      {products && products.length > 0 ? (
        <>
          <!-- üñ• DESKTOP TABLE -->
          <table class="hidden sm:table w-full border-collapse" id="desktopTable">
            <thead>
              <tr class="text-left border-b">
                <th class="py-3 px-2">Imagen</th>
                <th class="py-3 px-2">T√≠tulo</th>
                <th class="py-3 px-2">Categor√≠a</th>
                <th class="py-3 px-2">Precio</th>
                <th class="py-3 px-2">Destacado</th>
                <th class="py-3 px-2">Acciones</th>
              </tr>
            </thead>

            <tbody id="desktopBody">
              {
                products.map((p: Product & { categories?: { name: string } }) => (
                  <tr
                    class="border-b hover:bg-gray-50 productRow"
                    data-title={p.title.toLowerCase()}
                    data-category={p.categories?.name ?? 'Sin categor√≠a'}
                  >
                    <td class="py-2 px-2">
                      {p.image_url ? (
                        <img src={p.image_url} alt={p.title} class="w-16 h-16 object-cover rounded-lg" />
                      ) : (
                        <span class="text-gray-400 italic">Sin imagen</span>
                      )}
                    </td>

                    <td class="py-2 px-2 font-medium">{p.title}</td>

                    <td class="py-2 px-2">{p.categories?.name ?? 'Sin categor√≠a'}</td>

                    <td class="py-2 px-2">${p.price ?? '-'}</td>

                    <td class="py-2 px-2">{p.featured ? '‚≠ê' : '‚Äî'}</td>

                    <td class="py-2 px-2 flex gap-3">
                      <a href={`/admin/products/${p.id}`} class="text-blue-600 hover:underline">Editar</a>
                      <a href={`/admin/products/delete?id=${p.id}`} class="text-red-600 hover:underline">Eliminar</a>
                    </td>
                  </tr>
                ))
              }
            </tbody>
          </table>

          <!-- üì± MOBILE CARDS -->
          <div class="sm:hidden flex flex-col gap-4" id="mobileList">
            {
              products.map((p: Product & { categories?: { name: string } }) => (
                <div
                  class="border rounded-xl p-4 flex gap-4 shadow-md productCard"
                  data-title={p.title.toLowerCase()}
                  data-category={p.categories?.name ?? 'Sin categor√≠a'}
                >
                  <img src={p.image_url} class="w-20 h-20 object-cover rounded-lg" />

                  <div class="flex-1">
                    <h3 class="font-semibold text-[var(--color-primary)]">{p.title}</h3>

                    <p class="text-gray-700 text-sm mt-1">
                      Categor√≠a: <strong>{p.categories?.name ?? 'Sin categor√≠a'}</strong>
                    </p>

                    <p class="text-gray-700 text-sm">
                      Precio: <strong>${p.price ?? '-'}</strong>
                    </p>

                    <p class="text-gray-700 text-sm">
                      Destacado: {p.featured ? '‚≠ê' : '‚Äî'}
                    </p>

                    <div class="flex gap-4 mt-3 text-sm">
                      <a href={`/admin/products/${p.id}`} class="text-blue-600 hover:underline">Editar</a>
                      <a href={`/admin/products/delete?id=${p.id}`} class="text-red-600 hover:underline">Eliminar</a>
                    </div>
                  </div>
                </div>
              ))
            }
          </div>
        </>
      ) : (
        <p class="text-center text-gray-500 py-10">No hay productos registrados a√∫n.</p>
      )}
    </div>

  </section>

  <!-- üî• SCRIPT FILTROS -->
  <script is:inline>
    const filterCategory = document.getElementById("filterCategory");
    const searchInput = document.getElementById("searchInput");

    const desktopRows = document.querySelectorAll(".productRow");
    const mobileCards = document.querySelectorAll(".productCard");

    const applyFilters = () => {
      const text = searchInput.value.toLowerCase();
      const category = filterCategory.value;

      const match = (itemTitle, itemCategory) => {
        const matchText = itemTitle.includes(text);
        const matchCat = category === "all" || category === itemCategory;
        return matchText && matchCat;
      };

      desktopRows.forEach((row) => {
        const title = row.dataset.title;
        const cat = row.dataset.category;
        row.style.display = match(title, cat) ? "" : "none";
      });

      mobileCards.forEach((card) => {
        const title = card.dataset.title;
        const cat = card.dataset.category;
        card.style.display = match(title, cat) ? "" : "none";
      });
    };

    searchInput.addEventListener("input", applyFilters);
    filterCategory.addEventListener("change", applyFilters);
  </script>
</AdminLayout>
