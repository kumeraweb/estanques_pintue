---
export const prerender = false

import { supabase } from '../../../lib/supabase'

// Proteger ruta
const { data: sessionData } = await supabase.auth.getSession()
if (!sessionData.session) return Astro.redirect('/admin/login')

// ID desde query param
const id = Astro.url.searchParams.get('id')
if (!id) return Astro.redirect('/admin/products')

// Obtener producto (para borrar la imagen)
const { data: product } = await supabase.from('products').select('image_url').eq('id', id).single()

// Si hay imagen â†’ borrar archivo real
if (product?.image_url) {
  // Obtener path interno del bucket
  const path = product.image_url.split('/object/public/')[1]

  if (path) {
    await supabase.storage.from('products').remove([path])
  }
}

// Borrar fila
await supabase.from('products').delete().eq('id', id)

return Astro.redirect('/admin/products')
---
