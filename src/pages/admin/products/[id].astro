---
export const prerender = false

import AdminLayout from '../../../layouts/AdminLayout.astro'
import { supabase } from '../../../lib/supabase'

// Proteger ruta
const { data: sessionData } = await supabase.auth.getSession()
if (!sessionData.session) return Astro.redirect('/admin/login')

// Obtener ID del producto
const id = Astro.params.id

// Obtener producto
const { data: product, error } = await supabase.from('products').select('*').eq('id', id).single()

if (error || !product) {
  console.error(error)
  return Astro.redirect('/admin/products')
}

// Obtener categor√≠as
const { data: categories } = await supabase
  .from('categories')
  .select('*')
  .order('name', { ascending: true })

// Form submit (POST)
if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData()

  const title = form.get('title') as string
  const description = form.get('description') as string
  const price = Number(form.get('price'))
  const category_id = form.get('category_id') as string
  const featured = form.get('featured') === 'on'

  let image_url = product.image_url

  const file = form.get('image') as File | null

  // Si reemplaz√≥ imagen
  if (file && file.size > 0) {
    const fileName = `${Date.now()}-${file.name}`

    const { data: imgData, error: uploadError } = await supabase.storage
      .from('products')
      .upload(fileName, file, { contentType: file.type })

    if (!uploadError && imgData) {
      const { data: publicUrlData } = supabase.storage.from('products').getPublicUrl(imgData.path)

      image_url = publicUrlData.publicUrl
    }
  }

  // Actualizar en BD
  await supabase
    .from('products')
    .update({
      title,
      description,
      price,
      featured,
      category_id,
      image_url
    })
    .eq('id', id)

  return Astro.redirect('/admin/products')
}
---

<AdminLayout>
  <section class="min-h-screen px-6 py-10 bg-gray-100">
    <h1 class="text-3xl font-bold text-[var(--color-primary)] mb-6 text-center">
      ‚úèÔ∏è Editar Producto
    </h1>

    <form
      method="post"
      enctype="multipart/form-data"
      class="bg-white shadow-xl rounded-xl p-6 max-w-2xl mx-auto flex flex-col gap-4"
    >
      <label class="font-medium">T√≠tulo</label>
      <input
        type="text"
        name="title"
        value={product.title}
        required
        class="border rounded-lg px-4 py-3"
      />

      <label class="font-medium">Descripci√≥n</label>
      <textarea name="description" class="border rounded-lg px-4 py-3" rows="4">
        {product.description}
      </textarea>

      <label class="font-medium">Precio</label>
      <input
        type="number"
        name="price"
        value={product.price ?? ''}
        required
        class="border rounded-lg px-4 py-3"
      />

      <!-- Categor√≠a -->
      <label class="font-medium">Categor√≠a</label>
      <select name="category_id" required class="border rounded-lg px-4 py-3 bg-white">
        <option value="">Seleccionar categor√≠a...</option>
        {
          categories?.map((c) => (
            <option value={c.id} selected={product.category_id === c.id}>
              {c.name}
            </option>
          ))
        }
      </select>

      <!-- Featured -->
      <label class="font-medium flex items-center gap-2">
        <input type="checkbox" name="featured" checked={product.featured} />
        Producto destacado
      </label>

      <!-- Imagen -->
      <label class="font-medium">Reemplazar imagen (opcional)</label>
      <input type="file" name="image" accept="image/*" class="border rounded-lg px-4 py-3" />

      <button class="btn-primary mt-4" type="submit">üíæ Guardar cambios</button>
    </form>
  </section>
</AdminLayout>
