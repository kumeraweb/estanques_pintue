---
// @ts-check
export const prerender = false

import AdminLayout from '../../../layouts/AdminLayout.astro'
import { supabase } from '../../../lib/supabase'

// Proteger ruta
const { data: sessionData } = await supabase.auth.getSession()
if (!sessionData.session) {
  return Astro.redirect('/admin/login')
}

let errorMessage = null

// Cargar categorías
const { data: categories, error: catError } = await supabase
  .from('categories')
  .select('*')
  .order('name', { ascending: true })

if (catError) {
  console.error(catError)
}

if (Astro.request.method === 'POST') {
  try {
    const form = await Astro.request.formData()

    const title = form.get('title') as string
    const description = form.get('description') as string | null
    const price = Number(form.get('price'))
    const category_id = form.get('category_id') as string | null
    const featured = form.get('featured') === 'on'
    const imageFile = form.get('image') as File | null

    let image_url = null

    if (imageFile && imageFile.size > 0) {
      const fileName = `${Date.now()}-${imageFile.name}`

      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('products')
        .upload(fileName, imageFile, { contentType: imageFile.type })

      if (uploadError) throw new Error('Error subiendo imagen')

      const { data: publicUrl } = supabase.storage.from('products').getPublicUrl(uploadData.path)

      image_url = publicUrl.publicUrl
    }

    const { error: insertError } = await supabase.from('products').insert({
      title,
      description,
      price,
      category_id,
      featured,
      image_url
    })

    if (insertError) throw new Error('Error guardando producto')

    return Astro.redirect('/admin/products')
  } catch (err) {
    const e = err as Error
    errorMessage = e.message
  }
}
---

<AdminLayout>
  <section class="min-h-screen px-6 py-24 bg-gray-100">
    <h1 class="text-3xl font-bold text-[var(--color-primary)] mb-8 text-center">
      ➕ Crear Nuevo Producto
    </h1>

    <div class="bg-white shadow-xl rounded-xl p-8 max-w-3xl mx-auto">
      {errorMessage && <p class="text-red-600 text-center mb-4">{errorMessage}</p>}

      <form method="post" enctype="multipart/form-data" class="grid grid-cols-1 gap-6">
        <div>
          <label class="font-semibold">Título</label>
          <input type="text" name="title" required class="border rounded-lg px-4 py-3 w-full" />
        </div>

        <div>
          <label class="font-semibold">Descripción</label>
          <textarea name="description" class="border rounded-lg px-4 py-3 w-full"></textarea>
        </div>

        <div>
          <label class="font-semibold">Precio</label>

          <!-- INPUT visible (formatea CLP) -->
          <input
            type="text"
            id="priceDisplay"
            class="border rounded-lg px-4 py-3 w-full"
            placeholder="Ej $10.000"
            required
          />

          <!-- INPUT real que se envía -->
          <input type="hidden" name="price" id="priceReal" />
        </div>

        <!-- SELECT dinámico -->
        <div>
          <label class="font-semibold">Categoría</label>
          <select name="category_id" required class="border rounded-lg px-4 py-3 w-full bg-white">
            <option value="">Seleccionar categoría...</option>
            {categories?.map((c) => <option value={c.id}>{c.name}</option>)}
          </select>
        </div>

        <div>
          <label class="font-semibold">Imagen</label>
          <input
            type="file"
            name="image"
            accept="image/*"
            class="border rounded-lg px-4 py-3 w-full"
          />
        </div>

        <div class="flex items-center gap-3">
          <input type="checkbox" name="featured" id="featured" />
          <label for="featured">Destacado (más vendido)</label>
        </div>

        <button type="submit" class="btn-primary mt-4 w-full text-center">
          Guardar Producto
        </button>
      </form>
    </div>
  </section>
</AdminLayout>

<script is:inline>
  const formatCLP = (value) => {
    return new Intl.NumberFormat('es-CL', {
      style: 'currency',
      currency: 'CLP',
      minimumFractionDigits: 0
    }).format(value)
  }

  const display = document.getElementById('priceDisplay')
  const real = document.getElementById('priceReal')

  display.addEventListener('input', () => {
    let raw = display.value.replace(/\D/g, '') // quitar todo excepto números

    if (raw === '') {
      display.value = ''
      real.value = ''
      return
    }

    const numberValue = parseInt(raw, 10)

    display.value = formatCLP(numberValue)
    real.value = numberValue
  })
</script>
