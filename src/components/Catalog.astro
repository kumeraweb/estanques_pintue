---
import { MessageCircle } from 'lucide-astro'
import { supabase } from '../lib/supabase'
import { LINKS } from '../data/site'

// Obtener productos desde Supabase
const { data: products, error } = await supabase
  .from('products')
  .select('*')
  .order('category', { ascending: true })

if (error) console.error('Error cargando productos:', error)

// Tipo para mapear categorías → lista de productos
interface CatalogMap {
  [category: string]: any[]
}

// Crear estructura de categorías
const catalog: CatalogMap = {}

for (const p of products ?? []) {
  const category = p.category ?? 'Sin categoría'
  if (!catalog[category]) catalog[category] = []
  catalog[category].push(p)
}

// WhatsApp base
LINKS.wa()
---

<section id="catalogo" class="py-24 px-6 reveal">
  <div class="max-w-6xl mx-auto">
    <h2 class="section-title mb-2">Catálogo Completo</h2>
    <p class="text-gray-600 mb-12">
      Estanques, plantas, barricas y más. Todo actualizado en tiempo real.
    </p>

    {
      Object.entries(catalog).map(([category, items]) => (
        <div class="mb-16">
          <h3 class="text-2xl font-bold text-[var(--color-primary)] mb-6 capitalize">{category}</h3>

          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-8">
            {items.map((item) => (
              <div class="bg-white rounded-xl overflow-hidden shadow-md hover:shadow-lg transition">
                <img src={item.image_url} class="w-full h-48 object-cover" alt={item.title} />

                <div class="p-5">
                  <h4 class="text-xl font-semibold text-[var(--color-primary)]">{item.title}</h4>

                  <p class="text-gray-600 text-sm mt-2 mb-4">{item.description}</p>

                  <a
                    href={LINKS.wa(`Hola! Me interesa el producto: ${item.title}`)}
                    target="_blank"
                    class="w-full flex items-center justify-center gap-2 bg-[var(--color-primary)] text-white px-4 py-2 rounded-lg hover:opacity-90 transition font-medium"
                  >
                    Cotizar por WhatsApp
                  </a>
                </div>
              </div>
            ))}
          </div>
        </div>
      ))
    }
  </div>
</section>
